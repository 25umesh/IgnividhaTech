<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Recruitment - Registration</title>
        <script>
            // Tailwind-like theme init: read stored preference and set `dark` class early to avoid FOUC
            (function(){ try { const saved = localStorage.getItem('theme'); const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; const isDark = saved ? (saved === 'dark') : prefersDark; if (isDark) document.documentElement.classList.add('dark'); } catch(e){} })();
        </script>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">
        <!-- flatpickr for a better date picker UI -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <style>
            /* Light-mode overrides so the standalone register page follows the site theme */
            html:not(.dark) body { background: #f6f7fb !important; color: #0f172a !important; }
            html:not(.dark) .container { background: #ffffff !important; border: 1px solid rgba(15,23,42,0.06) !important; box-shadow: 0 6px 20px rgba(2,6,23,0.04) !important; }
            html:not(.dark) input, html:not(.dark) select, html:not(.dark) textarea { background: #ffffff !important; color: #0f172a !important; border-color: #e5e7eb !important; }
            html:not(.dark) .submit-btn { background: linear-gradient(90deg,#efefef,#e6e6e6) !important; color: #0b1220 !important; border: 1px solid rgba(11,18,32,0.06) !important; box-shadow: 0 6px 18px rgba(2,6,23,0.04) !important; }
            /* Page title styling: green in dark mode, slightly darker green in light mode */
            .page-title { color: #22c55e; /* emerald-500 */ font-size: 32px; font-weight: 800; margin-bottom: 12px; }
            html:not(.dark) .page-title { color: #15803d; /* emerald-700 for contrast on light bg */ }
        </style>
    <style>
        .flashes li { list-style: none; margin: 5px 0; padding: 10px; border-radius: 5px; }
        .flashes .success { background-color: #d4edda; color: #155724; }
        .flashes .error { background-color: #f8d7da; color: #721c24; }
        .conditional-fields { display: none; margin-top: 10px; }
        .project-inputs { margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="page-title">Developer Recruitment Registration Form</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form id="registrationForm" action="{{ url_for('register') }}" method="POST" enctype="multipart/form-data">

        <!-- Basic Information -->
        <section class="form-section">
            <h2>Basic Information</h2>
            <label for="fullname">Full Name:</label>
            <input type="text" id="fullname" name="fullname" placeholder="Your full name" required>

            <label for="email">Email Address:</label>
            <input type="email" id="email" name="email" placeholder="example@mail.com" required>

            <label for="contact">Contact Number:</label>
            <input type="tel" id="contact" name="contact" placeholder="Your contact number" required>

            <label for="dob">Date of Birth:</label>
            <!-- flatpickr-enhanced text input (replaces native date control) -->
            <input type="text" id="dob" name="dob" placeholder="YYYY-MM-DD" required style="padding:10px 12px; font-size:16px; border-radius:8px; width:260px;">
            <p id="ageDisplay" style="margin-top:6px; font-weight:600; color:#ef4444; display:none;">Age: <span id="calculatedAge"></span></p>

            <label>Current Status:</label>
            <div class="radio-group">
                <label><input type="radio" name="status" value="Student" required> Student</label>
                <label><input type="radio" name="status" value="Graduate"> Graduate</label>
            </div>

                        <label style="margin-top:12px; font-weight:700;">Profile Photo <span style="color:#ef4444">*</span></label>
                        <input type="file" name="profile_photo" id="profile_photo" accept="image/*" required>
                        <div id="profilePreviewWrap" style="margin-top:8px; display:none;">
                            <img id="profilePreview" alt="Profile preview" style="width:96px; height:96px; object-fit:cover; border-radius:9999px; border:2px solid #e5e7eb;" />
                        </div>
        </section>

        <!-- Work Details -->
        <section class="form-section">
            <h2>Work Details</h2>
            <label>Position Applying For (max 2):</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="position[]" value="Frontend Developer"> Frontend Developer</label>
                <label><input type="checkbox" name="position[]" value="Backend Developer"> Backend Developer</label>
                <label><input type="checkbox" name="position[]" value="Full Stack Developer"> Full Stack Developer</label>
                <label><input type="checkbox" name="position[]" value="App Developer"> App Developer</label>
            </div>
            <script>
            (function(){
                const form = document.getElementById('registrationForm');
                const boxes = Array.from(document.querySelectorAll('input[name="position[]"]'));
                const enforceLimits = () => {
                    const selected = boxes.filter(b => b.checked);
                    const count = selected.length;
                    // Disable remaining if 2 selected
                    boxes.forEach(b => {
                        if (!b.checked) b.disabled = count >= 2;
                        else b.disabled = false;
                    });
                };
                boxes.forEach(b => b.addEventListener('change', enforceLimits));
                form.addEventListener('submit', (e) => {
                    const count = boxes.filter(b => b.checked).length;
                    if (count < 1 || count > 2) {
                        // Use native validation without adding visible inline text
                        boxes[0].setCustomValidity('Please select at least 1 and at most 2 positions.');
                        boxes[0].reportValidity();
                        boxes[0].setCustomValidity('');
                        e.preventDefault();
                        return false;
                    }
                });
                // Initialize on load
                enforceLimits();
            })();
            </script>
        </section>

        <!-- Qualifications & Proofs -->
        <section class="form-section">
            <h2>Qualifications & Proofs</h2>

            <label>Hackathon Certificate (at least one required):</label>
            <input type="file" name="hackathon_cert[]" id="hackathon_cert" multiple required>

                <!-- Internship Certificate Upload -->
                <label id="internshipLabel" style="font-weight:700;">Internship Certificate (up to 10):</label>
                <input type="file" name="internship_cert[]" id="internship_cert" multiple max="10">

                <script>
                // Internship certificate field requirement logic
                function updateInternshipRequirement() {
                    const status = document.querySelector('input[name="status"]:checked')?.value;
                    const internshipInput = document.getElementById('internship_cert');
                    const internshipLabel = document.getElementById('internshipLabel');
                    if (status === 'Graduate') {
                        internshipInput.required = true;
                        internshipLabel.innerHTML = 'Internship Certificate (at least one required, up to 10):';
                    } else {
                        internshipInput.required = false;
                        internshipLabel.innerHTML = 'Internship Certificate (optional, up to 10):';
                    }
                }
                document.querySelectorAll('input[name="status"]').forEach(radio => {
                    radio.addEventListener('change', updateInternshipRequirement);
                });
                window.addEventListener('DOMContentLoaded', updateInternshipRequirement);
                </script>

            <!-- Student Section -->
            <div id="studentFields" class="conditional-fields">
                <label style="color:#15803d; font-weight:700;">College ID Card (required for students):</label>
                <input type="file" name="college_id">

                <label style="color:#15803d; font-weight:700;">Number of Projects to upload (optional):</label>
                <select id="studentProjectCount" name="studentProjectCount">
                    {% for i in range(0, 11) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
                <div id="studentProjectsContainer"></div>
            </div>

            <!-- Graduate Section -->
            <div id="graduateFields" class="conditional-fields">
                <label style="color:#15803d; font-weight:700;">Number of Projects to upload (mandatory):</label>
                <select id="graduateProjectCount" name="graduateProjectCount" required>
                    {% for i in range(0, 11) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
                <div id="graduateProjectsContainer"></div>
            </div>
        </section>

        <!-- Proof of Identity (Mandatory) -->
        <section class="form-section">
            <h2>Proof of Identity (Mandatory)</h2>
            <label for="id_proof_type">Choose ID Type:</label>
            <select id="id_proof_type" name="id_proof_type" required>
                <option value="">Select an option</option>
                <option value="Aadhaar Card">Aadhaar Card</option>
                <option value="PAN Card">PAN Card</option>
                <option value="DigiLocker">DigiLocker</option>
            </select>

            <label for="id_proof_file" style="margin-top:8px; font-weight:700;">Upload Photo of Selected ID:</label>
            <input type="file" id="id_proof_file" name="id_proof_file" accept="image/*" required>
        </section>

        <!-- Instagram Follow Proof -->
        <section class="form-section">
            <h2>Instagram Follow Proof</h2>
            <p>Please follow our Instagram account and upload a screenshot as proof.</p>
            <input type="file" name="insta_follow_proof" id="insta_follow_proof" required>
        </section>

        <!-- LinkedIn Follow Proof -->
        <section class="form-section">
            <h2>LinkedIn Follow Proof</h2>
            <p>If you follow our LinkedIn page, you can upload a screenshot as proof.</p>
            <input type="file" name="linkedin_follow_proof" id="linkedin_follow_proof">
        </section>

        <!-- Payment -->
        <section class="form-section">
            <h2>Payment</h2>
            <p>Click the button to view the QR code, complete the payment, then upload the proof.</p>
            <button type="button" id="showQrBtn" class="submit-btn" style="margin-bottom:10px;">Show QR to Pay</button>
            <div id="paymentProofWrap" style="display:none; margin-top:8px;">
                <label for="payment_proof" style="font-weight:700;">Upload Payment Proof (image or PDF):</label>
                <input type="file" name="payment_proof" id="payment_proof" accept="image/*,.pdf" required>
            </div>
        </section>

        <!-- QR Modal -->
        <div id="qrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
            <div id="qrPanel" style="background:#0b1220; color:#e5e7eb; width:min(92%,560px); border-radius:16px; border:1px solid rgba(255,255,255,0.08); padding:18px; transform:translateY(24px); opacity:0; transition:all .25s ease;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                    <h3 style="font-size:18px; font-weight:800; margin:0;">Scan to Pay</h3>
                    <button type="button" id="qrClose" title="Close" style="background:transparent; border:0; color:#94a3b8; font-size:22px; cursor:pointer;">×</button>
                </div>
                <p style="font-size:14px; color:#94a3b8; margin:0 0 12px;">Scan the QR code below to complete the payment. After payment, tap Done to upload your proof.</p>
                <div style="display:flex; justify-content:center;">
                    <img src="{{ url_for('static', filename='Qr.jpg') }}" alt="Payment QR" style="max-width:100%; width:320px; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background:#0f172a;" onerror="this.style.display='none'; document.getElementById('qrFallback').style.display='block';">
                </div>
                <div id="qrFallback" style="display:none; text-align:center; color:#f59e0b; font-size:14px; margin-top:8px;">QR image not found. Please add Qr.jpg inside the static folder.</div>
                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
                    <button type="button" id="qrDone" class="submit-btn">Done</button>
                </div>
            </div>
        </div>

        <!-- Social Media / Portfolio Links -->
        <section class="form-section">
            <h2>Social Media / Portfolio Links (Mandatory)</h2>
            <label for="github">GitHub <span style="color:#ef4444">*</span>:</label>
            <input type="url" id="github" name="github" required>

            <label for="linkedin">LinkedIn <span style="color:#ef4444">*</span>:</label>
            <input type="url" id="linkedin" name="linkedin" required>

            <label for="instagram">Instagram <span style="color:#ef4444">*</span>:</label>
            <input type="url" id="instagram" name="instagram">

            <label for="portfolio">Portfolio / Website:</label>
            <input type="url" id="portfolio" name="portfolio">
        </section>

        <!-- Declaration -->
        <section class="form-section">
            <label class="declaration">
                <input type="checkbox" name="declaration" required>
                I hereby declare that all information provided is true and that I have uploaded valid documents.
            </label>
        </section>

        <button type="submit" class="submit-btn">Submit Registration</button>
    </form>
</div>

<!-- flatpickr JS and all page scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Age calculation and client-side validation: allowed 18-27 inclusive
    const dobInput = document.getElementById('dob');
    const ageEl = document.getElementById('calculatedAge');
    const ageDisplay = document.getElementById('ageDisplay');

    function calculateAge(dob) {
        if (!dob) return null;
        const birth = new Date(dob);
        if (isNaN(birth.getTime())) return null;
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    function onDobChange() {
        const val = dobInput.value;
        const age = calculateAge(val);
        if (age === null || isNaN(age)) {
            ageDisplay.style.display = 'none';
            return;
        }
        ageEl.textContent = age;
        ageDisplay.style.display = 'block';
        if (age < 18 || age > 27) {
            ageDisplay.style.color = '#ef4444'; // red
        } else {
            ageDisplay.style.color = '#10b981'; // green
        }
    }

    // Initialize flatpickr on the DOB input for a full calendar widget
    if (typeof flatpickr !== 'undefined' && dobInput) {
        flatpickr(dobInput, {
            dateFormat: 'Y-m-d',
            altInput: false,
            allowInput: true,
            defaultDate: null,
            maxDate: new Date(),
            // Enable fast navigation through years via builtin controls
            // (flatpickr shows month arrows and allows year typing)
            onChange: function(selectedDates, dateStr) {
                onDobChange();
            }
        });
    }

    if (dobInput) dobInput.addEventListener('change', onDobChange);

    // Final client-side check before submit
    const form = document.getElementById('registrationForm');
    form.addEventListener('submit', function(e) {
        const dobVal = dobInput.value;
        const age = calculateAge(dobVal);
        if (age === null || isNaN(age)) {
            e.preventDefault();
            alert('Please enter a valid Date of Birth.');
            return;
        }
        if (age < 18 || age > 27) {
            e.preventDefault();
            alert('Age ' + age + ' is not eligible. Applicants must be between 18 and 27 years old.');
            return;
        }
        // Append a hidden input with the calculated age so server receives it reliably
        let hidden = document.getElementById('ageHidden');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'age';
            hidden.id = 'ageHidden';
            form.appendChild(hidden);
        }
        hidden.value = age;
    });

    // Field toggles and dynamic project inputs
    const studentFields = document.getElementById('studentFields');
    const graduateFields = document.getElementById('graduateFields');
    const statusRadios = document.querySelectorAll('input[name="status"]');

    function toggleFields() {
        const selected = document.querySelector('input[name="status"]:checked')?.value;
        if(selected === 'Student') {
            studentFields.style.display = 'block';
            graduateFields.style.display = 'none';
        } else if(selected === 'Graduate') {
            studentFields.style.display = 'none';
            graduateFields.style.display = 'block';
        }
    }

    statusRadios.forEach(radio => radio.addEventListener('change', toggleFields));
    if (studentFields) studentFields.style.display = 'none';
    if (graduateFields) graduateFields.style.display = 'none';

    function generateProjectInputs(containerId, count) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const projectDiv = document.createElement('div');
            projectDiv.className = 'project-inputs';
            projectDiv.innerHTML = `
                <h4>Project ${i}</h4>
                <label>Project Link:</label>
                <input type="url" name="${containerId}_project_link[]" placeholder="Add a link to your project that anyone can view" ${containerId === 'graduateProjectsContainer' ? 'required' : ''}>
                <label>Project Screenshot / File:</label>
                <input type="file" name="${containerId}_project_file[]" ${containerId === 'graduateProjectsContainer' ? 'required' : ''}>
            `;
            container.appendChild(projectDiv);
        }
    }

    const studentSelect = document.getElementById('studentProjectCount');
    const graduateSelect = document.getElementById('graduateProjectCount');
    if (studentSelect) studentSelect.addEventListener('change', () => {
        generateProjectInputs('studentProjectsContainer', parseInt(studentSelect.value));
    });
    if (graduateSelect) graduateSelect.addEventListener('change', () => {
        generateProjectInputs('graduateProjectsContainer', parseInt(graduateSelect.value));
    });

    // Limit checkbox selection to maximum 2 positions
    const positionCheckboxes = document.querySelectorAll('input[name="position[]"]');
    positionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checked = document.querySelectorAll('input[name="position[]"]:checked');
            if (checked.length > 2) {
                checkbox.checked = false;
                alert('You can select a maximum of 2 positions only.');
            }
        });
    });

    // Profile photo live preview
    const profileInput = document.getElementById('profile_photo');
    if (profileInput) {
        profileInput.addEventListener('change', () => {
            const file = profileInput.files && profileInput.files[0];
            const wrap = document.getElementById('profilePreviewWrap');
            const img = document.getElementById('profilePreview');
            if (file && wrap && img) {
                img.src = URL.createObjectURL(file);
                wrap.style.display = 'block';
            } else if (wrap) {
                wrap.style.display = 'none';
            }
        });
    }

    // Ensure an ID type is chosen when uploading ID photo
    const idType = document.getElementById('id_proof_type');
    const idFile = document.getElementById('id_proof_file');
    form.addEventListener('submit', function(e) {
        if (!idType || !idFile) return; // safety
        if (!idType.value) {
            e.preventDefault();
            alert('Please select a Proof of Identity type.');
            idType.focus();
            return;
        }
        if (!idFile.files || idFile.files.length === 0) {
            e.preventDefault();
            alert('Please upload a photo for the selected Proof of Identity.');
            idFile.focus();
            return;
        }
    });

    // Payment QR flow
    const showQrBtn = document.getElementById('showQrBtn');
    const qrModal = document.getElementById('qrModal');
    const qrPanel = document.getElementById('qrPanel');
    const qrClose = document.getElementById('qrClose');
    const qrDone = document.getElementById('qrDone');
    const paymentWrap = document.getElementById('paymentProofWrap');
    function openQr() {
        if (!qrModal || !qrPanel) return;
        qrModal.style.display = 'flex';
        requestAnimationFrame(() => {
            qrPanel.style.transform = 'translateY(0)';
            qrPanel.style.opacity = '1';
        });
        document.body.style.overflow = 'hidden';
    }
    function closeQr() {
        if (!qrModal || !qrPanel) return;
        qrPanel.style.transform = 'translateY(24px)';
        qrPanel.style.opacity = '0';
        setTimeout(() => { qrModal.style.display = 'none'; }, 200);
        document.body.style.overflow = '';
    }
    if (showQrBtn) showQrBtn.addEventListener('click', openQr);
    if (qrClose) qrClose.addEventListener('click', closeQr);
    if (qrModal) qrModal.addEventListener('click', (e) => { if (e.target === qrModal) closeQr(); });
    if (qrDone) qrDone.addEventListener('click', () => {
        closeQr();
        if (paymentWrap) {
            paymentWrap.style.display = 'block';
            // Scroll into view so user sees where to upload proof
            paymentWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
</script>
</body>
</html>
